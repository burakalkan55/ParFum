<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PARFUMÉ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="style7.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap"
    rel="stylesheet">


  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>

<body>
  <div class="header">
    <div class="container">
      <header class="d-flex flex-wrap justify-content-between py-3 mb-4 border-bottom">
        <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
          <svg class="bi me-2" width="40" height="32">
            <use xlink:href="#bootstrap"></use>
          </svg>
          <span class="fs-4 fw-bold" style="font-size: 1em;">PARFUMÉ</span>
        </a>

        <ul class="nav nav-pills">
          <li class="nav-item"><a href="./index.html" class="nav-link text-dark big fw-bold"
              aria-current="page">Home</a></li>
          <li class="nav-item"><a href="./products.html" class="nav-link text-dark big fw-bold">Products</a></li>
          <li class="nav-item"><a href="./profile.html" class="nav-link text-dark fw-bold"><svg
                xmlns="http://www.w3.org/2000/svg" width="33" height="36" fill="currentColor" class="bi bi-person-fill"
                viewBox="0 0 16 16">
                <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
              </svg></a></li>
          <li class="nav-item"><a href="./cart.html" class="nav-link active bg-dark text-white fw-bold"><svg
                xmlns="http://www.w3.org/2000/svg" width="33" height="36" fill="currentColor" class="bi bi-cart"
                viewBox="0 0 16 16">
                <path
                  d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M3.102 4l1.313 7h8.17l1.313-7zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4m-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2m7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2" />
              </svg></a></li>
        </ul>
      </header>
    </div>
  </div>
  <div class="container">
    <h1 class="h3 mb-5 text-center">Payment</h1>
    <div class="row">
      <!-- Left -->
      <div class="col-lg-9">
        <div class="accordion" id="accordionPayment">
          <!-- Credit card -->
          <div class="accordion-item mb-3">
            <h2 class="h5 px-4 py-3 accordion-header d-flex justify-content-between align-items-center">
              <div class="form-check w-100 collapsed" data-bs-toggle="collapse" data-bs-target="#collapseCC"
                aria-expanded="false">
                <input class="form-check-input" type="radio" name="payment" id="payment1">
                <label class="form-check-label pt-1" for="payment1">
                  Credit Card
                </label>
              </div>
              <span>
                <svg width="34" height="25" xmlns="http://www.w3.org/2000/svg">
                  <g fill-rule="nonzero" fill="#333840">
                    <path
                      d="M29.418 2.083c1.16 0 2.101.933 2.101 2.084v16.666c0 1.15-.94 2.084-2.1 2.084H4.202A2.092 2.092 0 0 1 2.1 20.833V4.167c0-1.15.941-2.084 2.102-2.084h25.215ZM4.203 0C1.882 0 0 1.865 0 4.167v16.666C0 23.135 1.882 25 4.203 25h25.215c2.321 0 4.203-1.865 4.203-4.167V4.167C33.62 1.865 31.739 0 29.418 0H4.203Z">
                    </path>
                    <path
                      d="M4.203 7.292c0-.576.47-1.042 1.05-1.042h4.203c.58 0 1.05.466 1.05 1.042v2.083c0 .575-.47 1.042-1.05 1.042H5.253c-.58 0-1.05-.467-1.05-1.042V7.292Zm0 6.25c0-.576.47-1.042 1.05-1.042H15.76c.58 0 1.05.466 1.05 1.042 0 .575-.47 1.041-1.05 1.041H5.253c-.58 0-1.05-.466-1.05-1.041Zm0 4.166c0-.575.47-1.041 1.05-1.041h2.102c.58 0 1.05.466 1.05 1.041 0 .576-.47 1.042-1.05 1.042H5.253c-.58 0-1.05-.466-1.05-1.042Zm6.303 0c0-.575.47-1.041 1.051-1.041h2.101c.58 0 1.051.466 1.051 1.041 0 .576-.47 1.042-1.05 1.042h-2.102c-.58 0-1.05-.466-1.05-1.042Zm6.304 0c0-.575.47-1.041 1.051-1.041h2.101c.58 0 1.05.466 1.05 1.041 0 .576-.47 1.042-1.05 1.042h-2.101c-.58 0-1.05-.466-1.05-1.042Zm6.304 0c0-.575.47-1.041 1.05-1.041h2.102c.58 0 1.05.466 1.05 1.041 0 .576-.47 1.042-1.05 1.042h-2.101c-.58 0-1.05-.466-1.05-1.042Z">
                    </path>
                  </g>
                </svg>
              </span>
            </h2>
            <div id="collapseCC" class="accordion-collapse collapse show" data-bs-parent="#accordionPayment">
              <div class="accordion-body">
                <div class="mb-3">
                  <label class="form-label">Card Number</label>
                  <input type="number" class="form-control" id="cardNumber" placeholder="">
                </div>
                <div class="row">
                  <div class="col-lg-6">
                    <div class="mb-3">
                      <label class="form-label">Name on card</label>
                      <input type="text" class="form-control" id="nameOnCard" placeholder="">
                    </div>
                  </div>
                  <div class="col-lg-3">
                    <div class="mb-3">
                      <label class="form-label">Expiry date</label>
                      <input type="number" class="form-control" id="expiryDate" placeholder="MM/YY">
                    </div>
                  </div>
                  <div class="col-lg-3">
                    <div class="mb-3">
                      <label class="form-label">CVV Code</label>
                      <input type="password" class="form-control" id="cvvCode">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
      <!-- Right -->
      <div class="col-lg-3">
        <div class="card position-sticky top-0">
          <div class="p-3 bg-light bg-opacity-10">
            <h6 class="card-title mb-3">Order Summary</h6>
            <div class="d-flex justify-content-between mb-1 small">
              Subtotal <span id="subtotalAmount"> </span>

            </div>
            <div class="d-flex justify-content-between mb-1 small">
              <span>Shipping</span> <span>$20.00</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between mb-4 small">
              <span>TOTAL</span> <span id="total"> </span>
            </div>




            <div class="form-check mb-1 small">
              <input class="form-check-input" type="checkbox" value="" id="termandcon">
              <label class="form-check-label" for="tnc">
                I agree to the <a href="./assets/terms.pdf" type="button" id="termbtn" data-bs-toggle="modal"
                  data-bs-target="#exampleModal">terms and conditions</a>
              </label>
            </div>



            <div class="form-check mb-3 small">
              <input class="form-check-input" type="checkbox" value="" id="subscribe">
              <label class="form-check-label" for="subscribe">
                Get emails about product updates and events. If you change your mind, you can unsubscribe at any time.
                <a href="./assets/privacy.pdf" type="button" id="privacybtn" data-bs-toggle="modal"
                  data-bs-target="#exampleModal">Privacy Policy</a>
              </label>


            </div>
            <button id="myBtn" type="button" class="w-100 btn btn-dark btn-custom" data-bs-toggle="modal"
              data-bs-target="#exampleModal" onclick="placeOrder()">Finish</button>
          </div>



        </div>
      </div>
    </div>
  </div>


  <!-- here -->
  <div class="container">


    <div class="mb-3">
      <label for="address">Address</label>
      <input type="text" class="form-control" id="address" placeholder="1234 Main St" required="" style="width: 66%">
      <div class="invalid-feedback">
        Please enter your shipping address.
      </div>
    </div>

    <div class="row">
      <div class="col-md-5 mb-3">
        <label for="country">Country</label>
        <select class="custom-select d-block w-100" id="country" required="">
          <option value="">Choose...</option>
          <option>Turkey</option>
        </select>
        <div class="invalid-feedback">
          Please select a valid country.
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <label for="zip">Zip</label>
        <input type="text" class="form-control" id="zip" placeholder="" required="">
        <div class="invalid-feedback">
          Zip code required.
        </div>
      </div>
    </div>
  </div>
  <div class="container-two">
    <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 mx-10 px-10 my-4 border-top">
      <div class="col-md-4 mx-10 d-flex align-items-center">
        <a href="/" class="mb-3 me-2 mb-md-0 text-muted text-decoration-none lh-1">
          <svg class="bi" width="30" height="24">
            <use xlink:href="#bootstrap"></use>
          </svg>
        </a>
        <span class="mb-3 mb-md-0 text-muted">© 2024 PARFUMÉ, Inc</span>
      </div>

      <ul class="nav col-md-4 mx-10 justify-content-end list-unstyled d-flex">
        <li class="ms-3"><a class="text-muted" href="https://app.swapkaart.com/id/wh7DDYI2oQcWikutV0MU"><svg
              xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-link-45deg"
              viewBox="0 0 16 16">
              <path
                d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z" />
              <path
                d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z" />
            </svg></a></li>
      </ul>
    </footer>
  </div>
</body>


<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCP7Nlbbo6BfFKsDJsqIFdbXLh3va5LbOs",
    authDomain: "webtechv3.firebaseapp.com",
    databaseURL: "https://webtechv3-default-rtdb.firebaseio.com", // Firebase Realtime Database URL'si
    projectId: "webtechv3",
    storageBucket: "webtechv3.appspot.com",
    messagingSenderId: "316228727012",
    appId: "1:316228727012:web:0aabf963396d1d03a4fcf1"
  };

  // Firebase projenize bağlan
  firebase.initializeApp(firebaseConfig);

  // Firebase veritabanına erişim için database değişkenini tanımla
  const database = firebase.database();

  // Kullanıcının oturum durumunu izle
  firebase.auth().onAuthStateChanged(function (user) {
    const subtotalAmountElement = document.getElementById("subtotalAmount");
    const allTotal = document.getElementById("total");

    if (subtotalAmountElement !== null) { // Öğe bulunduğunda işlem yap
      if (user) {
        const currentUserUID = user.uid;
        const userSubtotalRef = database.ref("users/" + currentUserUID + "/subtotal");

        userSubtotalRef.on("value", function (snapshot) {
          const subtotal = snapshot.val();
          if (subtotal !== null) { // Veri null değilse işlemi yap
            subtotalAmountElement.textContent = "$" + subtotal.toFixed(2);
            allTotal.textContent = "$" + (subtotal + 20).toFixed(2);
          } else { // Veri null ise, varsayılan değeri kullanabilirsiniz veya başka bir işlem yapabilirsiniz
            subtotalAmountElement.textContent = "$0.00";
          }
        });
      } else {
        subtotalAmountElement.textContent = "$0.00";
      }
    } else {
      console.error("subtotalAmountElement not found"); // Öğe bulunamazsa hata mesajı yazdır
    }
  });


  // Kullanıcının sepetindeki ürünlerin isimlerini ve adetlerini al
  function getCartItems(currentUserUID) {
    const userCartRef = database.ref("users/" + currentUserUID + "/cart");
    return userCartRef.once("value")
      .then(function (snapshot) {
        const cartItems = snapshot.val();
        return cartItems ? cartItems : {};
      });
  }
  // Sipariş oluştur
  function placeOrder() {
    var termsAndConditionsChecked = document.getElementById("termandcon").checked;
    var subscribeChecked = document.getElementById("subscribe").checked;

    if (termsAndConditionsChecked && subscribeChecked) {
      // Kullanıcı bilgilerini al
      const user = firebase.auth().currentUser;
      if (user) {
        const currentUserUID = user.uid;

        // Sepette ürün var mı kontrol et
        getCartItems(currentUserUID).then(function (cartItems) {
          if (Object.keys(cartItems).length === 0) {
            alert("Your cart is empty. Please add items to your cart before placing an order.");
            return;
          }

          // Kart bilgilerini al
          const cardNumber = document.getElementById("cardNumber").value;
          const nameOnCard = document.getElementById("nameOnCard").value;
          const expiryDate = document.getElementById("expiryDate").value;
          const cvvCode = document.getElementById("cvvCode").value;

          // Adres bilgilerini al
          const address = document.getElementById("address").value;
          const country = document.getElementById("country").value;
          const zip = document.getElementById("zip").value;

          // Kart bilgileri ve adres bilgileri boş değilse ve geçerliyse devam et
          if (cardNumber.trim() !== "" && nameOnCard.trim() !== "" && expiryDate.trim() !== "" && cvvCode.trim() !== "" &&
            address.trim() !== "" && country.trim() !== "" && zip.trim() !== "") {
            // Kart numarasının 16 haneli olduğunu ve sadece rakamlardan oluştuğunu kontrol et
            if (cardNumber.length !== 16 || isNaN(cardNumber)) {
              alert("Invalid card number. Card number must be a 16-digit number.");
              return;
            }

            // CVV'nin 3 haneli olduğunu ve sadece rakamlardan oluştuğunu kontrol et
            if (cvvCode.length !== 3 || isNaN(cvvCode)) {
              alert("Invalid CVV code. CVV code must be a 3-digit number.");
              return;
            }

            // Expiry date'in 4 haneli olduğunu ve sadece rakamlardan oluştuğunu kontrol et
            if (expiryDate.length !== 4 || isNaN(expiryDate)) {
              alert("Invalid expiry date. Expiry date must be a 4-digit number (MMYY format).");
              return;
            }

            // Anlık fiyatı al
            const currentPrice = parseFloat(document.getElementById("total").textContent.replace("$", ""));
            if (isNaN(currentPrice)) {
              alert("Error getting current price.");
              return;
            }

            // Function to format date
            function formatDate(timestamp) {
              const date = new Date(timestamp);
              const formattedDate = date.toLocaleString('en-US', { timeZone: 'UTC' }); // Adjust timezone if needed
              return formattedDate;
            }

            // Kullanıcının sepetindeki ürünlerin isimlerini ve adetlerini al
            getCartItems(currentUserUID).then(function (cartItems) {
              // Sipariş verisi
              const orderData = {
                timestamp: firebase.database.ServerValue.TIMESTAMP, // Current server timestamp
                price: currentPrice,
                items: cartItems,
                cardNumber: cardNumber,
                nameOnCard: nameOnCard,
                expiryDate: expiryDate,
                cvvCode: cvvCode,
                address: address,
                country: country,
                zip: zip
              };

              // Realtime Database'e sipariş verisini ekle
              const orderRef = database.ref("users/" + currentUserUID + "/orders").push();
              orderRef.set(orderData)
                .then(function () {
                  // Sepeti temizle
                  return clearCart(currentUserUID);
                })
                .then(function () {
                  // Subtotalı sıfırla
                  return resetSubtotal(currentUserUID);
                })
                .then(function () {
                  alert("Order placed successfully!");
                  window.location.href = "profile.html" //testing
                })
                .catch(function (error) {
                  alert("Error placing order: " + error.message);
                });
            });
          } else {
            alert("Please fill out all card and address information.");
          }
        });
      } else {
        alert("Please sign in to proceed.");
      }
    } else {
      alert("Please agree to terms and conditions and privacy policy.");
    }
  }

  // Sepeti temizle
  function clearCart(currentUserUID) {
    const userCartRef = database.ref("users/" + currentUserUID + "/cart");
    return userCartRef.remove();
  }

  // Subtotalı sıfırla
  function resetSubtotal(currentUserUID) {
    const userSubtotalRef = database.ref("users/" + currentUserUID + "/subtotal");
    return userSubtotalRef.set(0);
  }


</script>
</html>